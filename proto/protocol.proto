syntax = "proto3";

package protocol;

import "google/rpc/status.proto";

message Triple {
  optional bytes entity_id = 1;
  // TODO: describe the hashing algorithm used to get this id
  optional bytes attribute_id = 2;
  TripleValue value = 3;
}

message TripleValue {
  oneof value {
    string string = 3;
    double number = 4;
    bool boolean = 5;
  }
}

message ClientMessage {
  // A unique ID determined by the client. This ID enables the client
  // to match the request and response, as well as allow for idempotent retries.
  optional uint32 request_id = 1;
  oneof payload {
    TripleUpdateRequest triple_update_request = 2;
    QueryRequest query = 3;
    // SubscribeRequest subscribe = 3; // Reactive subscription
    // uint32 unsubscribe_id = 4; // subscription_id to stop
  }
}

message QueryRequest {
  // These are the fields to return
  repeated QueryPatternVariable find = 1;
  // The patterns to match against
  repeated QueryPattern where = 2;
}

message QueryPattern {
  oneof entity {
    bytes entity_id = 1;
    QueryPatternVariable entity_variable = 2;
  }

  oneof attribute {
    bytes attribute_id = 3;
    QueryPatternVariable attribute_variable = 4;
  }

  oneof value_group {
    TripleValue value = 5;
    QueryPatternVariable value_variable = 6;
  }
}

message QueryPatternVariable {
  optional string label = 1;
}

// message SubscribeRequest {
//   uint32 subscription_id = 1;
//   // repeated Pattern patterns = 2;
//   string since_hlc = 3; // Optional: Resume from this point
// }

message TripleUpdateRequest {
  repeated Triple triples = 1;
}

message ServerMessage {
  ServerResponse response = 1;
  // oneof payload {
  //   // QueryResult result = 2; // Response to QueryRequest
  //   // TripleUpdate update = 3; // Streamed update from subscription
  //   // Ack ack = 4; // Response to TransactRequest
  // }
}

message ServerResponse {
  optional uint32 request_id = 1;
  optional google.rpc.Status status = 2;
  // Query results (populated for QueryRequest responses)
  repeated Triple triples = 3;
}
