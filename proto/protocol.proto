syntax = "proto3";

package protocol;

import "google/rpc/status.proto";

// Represents a single triple (entity, attribute, value) in the database.
message Triple {
  // Unique identifier for the entity. Must be exactly 16 bytes.
  // Requests with entity IDs of other lengths will be rejected with
  // InvalidArgument.
  optional bytes entity_id = 1;
  // Unique identifier for the attribute. Must be exactly 16 bytes.
  // Requests with attribute IDs of other lengths will be rejected with
  // InvalidArgument.
  optional bytes attribute_id = 2;
  // The value associated with this entity-attribute pair.
  TripleValue value = 3;
  // HLC timestamp for conflict resolution. Required for update requests.
  // In responses, contains the current timestamp of the stored value.
  optional HlcTimestamp hlc = 4;
}

// Hybrid Logical Clock timestamp for conflict resolution.
message HlcTimestamp {
  // Physical time in milliseconds since Unix epoch.
  uint64 physical_time_ms = 1;
  // Logical counter for ordering events at the same physical time.
  uint32 logical_counter = 2;
  // Node identifier for distributed uniqueness.
  uint32 node_id = 3;
}

// The value component of a triple. Supports string, number, and boolean types.
message TripleValue {
  oneof value {
    // String value. Maximum length is 1024 characters.
    // Strings exceeding this limit will be rejected with InvalidArgument.
    string string = 3;
    // Numeric value (IEEE 754 double-precision floating point).
    double number = 4;
    // Boolean value.
    bool boolean = 5;
  }
}

// Request to establish a connection. Must be the first message sent by the
// client after WebSocket handshake.
message ConnectRequest {
  // API key identifying the application. Determines which database file to use:
  // {app_api_key}.db. Valid characters: alphanumeric, hyphens, underscores.
  // Maximum length: 256 characters.
  string app_api_key = 1;
}

message ClientMessage {
  // A unique ID determined by the client. This ID enables the client
  // to match the request and response, as well as allow for idempotent retries.
  optional uint32 request_id = 1;
  oneof payload {
    TripleUpdateRequest triple_update_request = 2;
    QueryRequest query = 3;
    SubscribeRequest subscribe = 4;
    UnsubscribeRequest unsubscribe = 5;
    ConnectRequest connect = 6;
  }
}

message QueryRequest {
  // These are the fields to return
  repeated QueryPatternVariable find = 1;
  // The patterns to match against
  repeated QueryPattern where = 2;
  // Optional patterns (left join semantics)
  repeated QueryPattern optional = 3;
  // Negation patterns (anti-join)
  repeated QueryPattern where_not = 4;
}

message QueryPattern {
  oneof entity {
    bytes entity_id = 1;
    QueryPatternVariable entity_variable = 2;
  }

  oneof attribute {
    bytes attribute_id = 3;
    QueryPatternVariable attribute_variable = 4;
  }

  oneof value_group {
    TripleValue value = 5;
    QueryPatternVariable value_variable = 6;
  }
}

message QueryPatternVariable {
  optional string label = 1;
}

// Request to subscribe to triple changes.
message SubscribeRequest {
  // Client-assigned subscription identifier. Used to match updates and for
  // unsubscribing. Must be unique per connection.
  uint32 subscription_id = 1;
  // Optional HLC timestamp to resume from. If provided, the server will first
  // send all changes since this timestamp, then continue with real-time updates.
  optional HlcTimestamp since_hlc = 2;
}

// Request to cancel an active subscription.
message UnsubscribeRequest {
  // The subscription identifier to cancel.
  uint32 subscription_id = 1;
}

// Types of changes that can occur to triples.
enum ChangeType {
  CHANGE_TYPE_UNSPECIFIED = 0;
  CHANGE_TYPE_INSERT = 1;
  CHANGE_TYPE_UPDATE = 2;
  CHANGE_TYPE_DELETE = 3;
}

// A single change record representing a triple modification.
message ChangeRecord {
  // The type of change.
  ChangeType change_type = 1;
  // The affected triple. For DELETE operations, only entity_id, attribute_id,
  // and hlc are populated; value is not included.
  Triple triple = 2;
}

// Streaming update sent to subscribers when triples change.
message SubscriptionUpdate {
  // The subscription this update belongs to.
  uint32 subscription_id = 1;
  // The change records. May contain multiple changes per message.
  repeated ChangeRecord changes = 2;
}

message TripleUpdateRequest {
  repeated Triple triples = 1;
}

message ServerMessage {
  oneof payload {
    // Response to a client request (query, update, subscribe, unsubscribe).
    ServerResponse response = 1;
    // Streaming update pushed to subscribers when triples change.
    SubscriptionUpdate subscription_update = 2;
  }
}

// A single value in a query result row
message QueryResultValue {
  oneof value {
    string id = 1; // Entity or Field ID as string
    TripleValue triple_value = 2; // Actual value (string, number, boolean)
  }
  bool is_undefined = 3; // True if value is missing (for optional patterns)
}

// A row of query results
message QueryResultRow {
  repeated QueryResultValue values = 1;
}

message ServerResponse {
  optional uint32 request_id = 1;
  optional google.rpc.Status status = 2;
  // Query results (populated for QueryRequest responses)
  repeated Triple triples = 3;
  // Columnar query results
  repeated string columns = 4;
  repeated QueryResultRow rows = 5;
}
